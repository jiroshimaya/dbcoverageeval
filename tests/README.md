# テスト実行手順

このドキュメントでは、「質問カバー率測定パイプライン」のテスト実行方法について説明します。

## 前提条件

テストを実行するには、以下のパッケージが必要です。

```
pytest
pytest-cov
```

これらは以下のコマンドでインストールできます：

```bash
pip install pytest pytest-cov
```

## テストの実行

### 全テストの実行

プロジェクトのルートディレクトリで以下のコマンドを実行します：

```bash
pytest
```

これにより、`tests/` ディレクトリ内のすべてのテストが実行されます。

### カバレッジレポートの生成

テストの網羅率（カバレッジ）を確認するには、以下のコマンドを実行します：

```bash
pytest --cov=dbcoverageeval --cov-report=term-missing
```

これにより、テストでカバーされていないコード行が表示されます。

### 特定のテストファイルの実行

特定のモジュールのテストだけを実行するには、以下のように指定します：

```bash
# ingestモジュールのテストのみ実行
pytest tests/test_ingest.py

# judgeモジュールのテストのみ実行
pytest tests/test_judge.py
```

### 詳細な出力

より詳細なテスト出力を得るには、`-v` オプションを使用します：

```bash
pytest -v
```

## テストの概要

テストは以下のカテゴリに分かれています：

1. **ユニットテスト**: 各モジュールの関数やクラスが期待通りに動作するかをテストします。
2. **機能テスト**: モジュール間の連携や、より大きな機能をテストします。
3. **CLIテスト**: コマンドラインインターフェースの動作をテストします。

## モック化について

外部APIやリソースを使用するテストでは、モックを使用しています。主なモックは：

- `mock_openai_embeddings`: OpenAIのエンベディングAPIをモック化します。
- `mock_openai_chat_completions`: OpenAIのチャット完了APIをモック化します。

これらのモックにより、実際のAPIを呼び出すことなくテストが実行できます。

## フィクスチャについて

テストでは、以下の共通フィクスチャを使用しています：

- `temp_dir`: 一時ディレクトリを提供します。
- `sample_config`: テスト用の設定情報を提供します。
- `config_file`: テスト用の設定ファイルを提供します。
- `sample_chunks`: テスト用のテキストチャンクを提供します。
- `chunks_parquet`: テスト用のParquetファイルを提供します。
- `sample_questions`: テスト用の質問リストを提供します。
- `questions_tsv`: テスト用の質問TSVファイルを提供します。
- `questions_csv`: テスト用の質問CSVファイルを提供します。

## トラブルシューティング

### テストの失敗

テストが失敗した場合は、以下を確認してください：

1. 必要なパッケージがすべてインストールされているか
2. テスト用のモックや前提条件が正しく設定されているか
3. コードが最新であるか

### 特定のテストのスキップ

特定のテストをスキップするには、`@pytest.mark.skip` デコレータを使用します：

```python
@pytest.mark.skip(reason="一時的に無効化")
def test_something():
    ...
```

### APIキーが必要なテスト

一部のテストでは、OpenAIなどのAPIキーが必要な場合があります。これらのテストは通常モック化されていますが、実際のAPIを使用してテストする場合は、適切な環境変数を設定してください。
